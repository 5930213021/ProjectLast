<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>MCarcare</title>

  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">


  <link href="https://fonts.googleapis.com/css?family=Archivo+Black&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Bai+Jamjuree|Lato&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Athiti:300,400,500|Sarabun:200&display=swap" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="css/homeStaff.css">

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">

  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
  <script src="js/ejs.js"></script>
  <script src="cordova.js"></script>



</head>

<body onload="show_staff(),show_times()">
  <ons-navigator swipeable id="myNavigator" page="homeStaff.html"></ons-navigator>

  <template id="homeStaff.html">
    <ons-page>
      <ons-toolbar id="headbar">
        <div class="left" id="appname">
          Mcarcare
        </div>
        <div class="right">
          <ons-icon class="toolbaricon" size="25px" icon="md-power" style="margin-right:10px;" onclick="showModal()">
          </ons-icon>
        </div>
      </ons-toolbar>
      <ons-modal direction="up">
        <div style="text-align: center">
          <p>
            <ons-icon icon="md-spinner" size="28px" spin></ons-icon> ออกจากระบบ...
          </p>
        </div>
      </ons-modal>

      <div class="row" id="showStaff">
        default
      </div>

      <!--  <div class="proname">
        <ons-list-item>
            <div class="left">
              <img class="list-item__thumbnail" src="img/picpro3.gif">
            </div>
            <div class="center">
              <span class="list-item__title">ป้านิด ศรีราชา</span>
              <span class="list-item__subtitle">พนักงานดูแล</span>
            </div>
          </ons-list-item> 
      </div>-->

      <div class="progress-bar progress-bar--material">
        <div class="progress-bar__primary progress-bar--material__primary" style="width: 100%"></div>
      </div><br>

      <div class="row" id="showTimes">
        defaultTimes
      </div>

    </ons-page>
  </template>

  <template id="detailState.html">
    <ons-page>
      <div class="background"></div>
      <p>
        <ons-back-button>
          <ons-icon icon="md-chevron-left"></ons-icon>
          กลับ
        </ons-back-button>
      </p>
      <div class="namedata">รายละเอียดข้อมูล</div>
      <div class="picuser">
        <ons-list-item>
          <div class="center">
            <img class="list-item__thumbnail" src="img/mirage-1284.jpg" id="pic">
          </div>
        </ons-list-item>
      </div>

      <ons-card>
        <div class="title">ชื่อ :
          <ons-input id="snap" placeholder="ส้มดี"></ons-input>
        </div>
        <div class="title">เบอร์โทรฯ :
          <ons-input id="snap" type="number" placeholder="099-7654321"></ons-input>
        </div>
        <div class="title">ป้ายทะเบียน :
          <ons-input id="snap" placeholder="กข ภูเก็ต 2541"></ons-input>
        </div>
        <div class="title">ประเภทรถ :
          <ons-input id="snap" placeholder="เก๋ง"></ons-input>
        </div>
        <div class="title">สีรถ :
          <ons-input id="snap" placeholder="แดง"></ons-input>
        </div>
        <div class="title">รายการลูกค้า :
          <ons-input id="snap" placeholder="ล้างห้องเครื่อง"></ons-input>
        </div>
      </ons-card>

      <ons-row style="margin-top: 15px;">
        <ons-col style="flex: 0 0 70%;margin: auto;max-width: 70%;">
          <label class="radio-button radio-button--material" style="margin-left: 30px;">
            <input type="radio" class="radio-button__input radio-button--material__input" name="r" checked="checked">
            <div class="radio-button__checkmark radio-button--material__checkmark"></div>
            ขนาดเล็ก
          </label>
          <label class="radio-button radio-button--material" style="margin-left: 30px;">
            <input type="radio" class="radio-button__input radio-button--material__input" name="r">
            <div class="radio-button__checkmark radio-button--material__checkmark"></div>
            ขนาดใหญ่
          </label>
        </ons-col>
      </ons-row>

      <div class="setbtn">
        <ons-button onclick="" id="btnpass">
          เลื่อนเวลา
        </ons-button>
        <ons-button onclick="alertsubmit()" id="btnsubmit">
          ยืนยัน
        </ons-button>
        <ons-button onclick="alertcancle()" id="btncancle">
          ยกเลิก
        </ons-button>
      </div>
    </ons-page>
  </template>


  <template id="alert-dialog.html">
    <ons-alert-dialog id="my-alert-dialog" modifier="rowfooter">
      <!-- <div class="alert-dialog-title">Alert</div> -->
      <div class="alert-dialog-content">
        ระดับความสกปรก
      </div>
      <!-- <div class="alert-dialog-footer">
          <ons-alert-dialog-button onclick="hideAlertDialog()">มาก</ons-alert-dialog-button>
          <ons-alert-dialog-button onclick="hideAlertDialog()">น้อย</ons-alert-dialog-button>
        </div> -->
      <div class="alert-dialog-footer">
        <ons-alert-dialog-button onclick="window.location.href='homeaddmin2.html'">มาก</ons-alert-dialog-button>
        <ons-alert-dialog-button onclick="window.location.href='homeaddmin2.html'">น้อย</ons-alert-dialog-button>
        <!-- <ons-alert-dialog-button onclick="hideAlertDialog()">น้อย</ons-alert-dialog-button> -->
      </div>
    </ons-alert-dialog>
  </template>

  <template id="alert-messenge.html">
    <ons-alert-dialog id="my-alert-messenge" modifier="rowfooter">
      <!-- <div class="alert-dialog-title">Alert</div> -->
      <div class="alert-dialog-content">
        คุณต้องการที่จะส่งข้อความไปยังลูกค้าใช่หรือไม่?
      </div>
      <div class="alert-dialog-footer">
        <ons-alert-dialog-button onclick="hideAlertDialog2()">ไม่</ons-alert-dialog-button>
        <ons-alert-dialog-button onclick="hideAlertDialog2()">ส่งข้อความ</ons-alert-dialog-button>
      </div>
    </ons-alert-dialog>
  </template>

  <template id="alert-cancle.html">
    <ons-alert-dialog id="my-alert-cancle" modifier="rowfooter">
      <!-- <div class="alert-dialog-title">Alert</div> -->
      <div class="alert-dialog-content">
        ต้องการยกเลิกการจองลูกค้า?
      </div>
      <div class="alert-dialog-footer">
        <ons-alert-dialog-button onclick="window.location.href='addmincancle.html'">ตกลง</ons-alert-dialog-button>
        <ons-alert-dialog-button onclick="window.location.href='homeaddmin.html'">ยกเลิก</ons-alert-dialog-button>
        <!-- <ons-alert-dialog-button onclick="hideAlertDialog3()">ยกเลิก</ons-alert-dialog-button> -->
      </div>
    </ons-alert-dialog>
  </template>

</body>

<script>
  console.log("phone :: " + localStorage.getItem("phone"));

  function showModal() {
    var modal = document.querySelector('ons-modal');
    modal.show();
    setTimeout(function () {
      // modal.hide();
      window.location.href = 'login.html';
    }, 1500);
  }

  async function show_staff() {

    let phone = localStorage.getItem("phone");
    axios.get('http://localhost:8080/user/showStaff?phone=' + phone)
      .then(function (response) {
        var dc = [];
        let data = response.data
        console.log("Data :: " + JSON.stringify(data));
        data.forEach(staff => {
          dc += `
                  <div class="toolbar" id="name_staff">
                    <div class="toolbar__center" id="colorback">${staff.fname} ${staff.lname}</div>
                  </div>
                `
        })
        myobj = document.getElementById("showStaff");
        myobj.innerHTML = dc;
        // localStorage.setItem("car_num" , car_num);
        console.log(myobj);
      })
      .catch(function (error) {
        // handle error
        console.log(error);
      })
  }

  async function show_times() {
    try {
      // const responseCar = await axios.get('http://localhost:8080/user/getshowcar' )
      const responseTime = await axios.get('http://localhost:8080/user/showtimes');
      const responseWork = await axios.get('http://localhost:8080/user/showwork');

      let data = responseTime.data
      if (responseWork.data) {
        var dc = [];
        data = responseTime.data.map(time => {
          console.log('ก่อน', time);
          time.hasWork = 0; // เพิ่ม haswork ให้ time ก้อนนี้ มันวนไง แต่ล่ะก้อนอ่ะ
          console.log('หลัง', time);

          const workOnThisTime = responseWork.data.filter(workInFilter => workInFilter.times === time.times).map(workInFilter => workInFilter.car_num)
          // if (workOnThisTime) {
          //   time.hasWork = workOnThisTime.length;
          // time.hascar = workOnThisTime;
          // console.log('ถ้ามีwork', time);
          // }
          time.hasWork = workOnThisTime.length;

          localStorage.setItem("numwork", time.hasWork);

          time.hascar = workOnThisTime;
          console.log('ถ้ามีwork', time);

          const className = time.hasWork ? 'has-book' : 'empty';
          const text = time.hasWork ? 'มีการจอง' : 'ว่าง';

          let num = localStorage.getItem("numwork");
          console.log(num);
         
          dc += `
          <ons-card >
          <ons-list>
            <ons-list-header>${time.times}</ons-list-header>
            <ons-list-item>
              <ons-row idth="50%">

                <ons-col>
                  <button class="button--cta ${className}" onclick="detail(${time.times})">
                    <p>${time.hascar}</p>
                    <p>${text}</p>
                  </button>
                  <button class="button button--light" id="btn" onclick="alertmessenge()">ส่งข้อความ</button>
                </ons-col>
 
                <ons-col>
                  <button class="button--cta ${className}">
                      <p>${time.hascar}</p>
                    <p>${text}</p>
                  </button>
                  <button class="button button--light" id="btn" onclick="alertmessenge()">ส่งข้อความ</button>
                </ons-col>


              </ons-row>
            </ons-list-item>
          </ons-list>
        </ons-card>
               `

          return time;
        })
        myobj = document.getElementById("showTimes");
        myobj.innerHTML = dc;
        console.log(myobj);
      }
    } catch (error) {
      console.log(error);
    }

  }


  var detail = function (times) {
    console.log(times);
    localStorage.setItem("times", times);
    appNavigator.pushPage('detailState.html')
  }




  // Alert submit
  var alertsubmit = function () {
    var dialog = document.getElementById('my-alert-dialog');

    if (dialog) {
      dialog.show();
    } else {
      ons.createElement('alert-dialog.html', { append: true })
        .then(function (dialog) {
          dialog.show();
        });
    }
  };

  // Alert cancle
  var alertcancle = function () {
    var dialog3 = document.getElementById('my-alert-cancle');

    if (dialog3) {
      dialog3.show();
    } else {
      ons.createElement('alert-cancle.html', { append: true })
        .then(function (dialog3) {
          dialog3.show();
        });
    }
  };

  // Alert messenge
  var alertmessenge = function () {
    var dialog2 = document.getElementById('my-alert-messenge');

    if (dialog2) {
      dialog2.show();
    } else {
      ons.createElement('alert-messenge.html', { append: true })
        .then(function (dialog2) {
          dialog2.show();
        });
    }
  };

  var hideAlertDialog = function () {
    document
      .getElementById('my-alert-dialog')
      .hide();
  };

  var hideAlertDialog2 = function () {
    document
      .getElementById('my-alert-messenge')
      .hide();
  };

  var hideAlertDialog3 = function () {
    document
      .getElementById('my-alert-messenge')
      .hide();

  };


</script>

</html>