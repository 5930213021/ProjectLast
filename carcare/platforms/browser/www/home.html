<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>MCarcare</title>

  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">

  <link href="https://fonts.googleapis.com/css?family=Archivo+Black&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Bai+Jamjuree|Lato&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Athiti:300,400,500|Sarabun:200&display=swap" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="css/home.css">


  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">

  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
  <script src="js/ejs.js"></script>
  <script src="cordova.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>

</head>

<body>
  <ons-navigator id="appNavigator" swipeable swipe-target-width="80px">
    <ons-page>
      <ons-splitter id="appSplitter">
        <ons-splitter-side id="sidemenu" page="sidemenu.html" swipeable side="right" collapse="" width="260px">
        </ons-splitter-side>
        <ons-splitter-content page="tabbar.html"></ons-splitter-content>
      </ons-splitter>
    </ons-page>

    <ons-modal direction="up">
      <div style="text-align: center">
        <p>
          <ons-icon icon="md-spinner" size="28px" spin></ons-icon> Loading...
        </p>
      </div>
    </ons-modal>

  </ons-navigator>

  <template id="tabbar.html">
    <ons-page id="tabbar-page">
      <ons-toolbar id="headbar">
        <div class="center" id="appname">Mcarcare</div>
        <div class="right">
          <ons-toolbar-button onclick="fn.toggleMenu()">
            <ons-icon icon="ion-navicon, material:md-menu" style="color: rgb(1, 100, 117);"></ons-icon>
          </ons-toolbar-button>
        </div>
      </ons-toolbar>

      <ons-tabbar swipeable position="auto" id="appTabbar">
        <ons-tab page="home2.html" label="หน้าหลัก" icon="ion-home, material:md-home" badge="1" active></ons-tab>
        <ons-tab page="booking.html" label="จองคิว" icon="fa-car" active-icon="fa-car" id="books" onclick="book()">
        </ons-tab>
        <ons-tab page="message.html" label="ข้อความ" icon="fa-envelope" badge="1"></ons-tab>
        <ons-tab page="history.html" label="ประวัติฯ" icon="fa-list-ul"></ons-tab>
      </ons-tabbar>

      <script>
        ons.getScriptPage().addEventListener('prechange', function (event) {
          if (event.target.matches('#appTabbar')) {
            event.currentTarget.querySelector('ons-toolbar .center').innerHTML = event.tabItem.getAttribute('label');
          }
        });
      </script>
    </ons-page>
  </template>

  <template id="sidemenu.html">
    <ons-page>
      <!-- <div class="profile-pic">
            <img src="img/picpro3.gif">
        </div> -->

      <ons-list-title><br></ons-list-title>
      <!-- เมนู -->
      <ons-list>
        <ons-list-item onclick="window.location.href='profile2.html'">

          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-account, material:md-account"></ons-icon>
          </div>
          <div class="center">ข้อมูลส่วนตัว
          </div>
        </ons-list-item>

        <ons-list-item onclick="fn.loadView(0)">
          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-home, material:md-home"></ons-icon>
          </div>
          <div class="center">หน้าหลัก</div>
          <!-- <div class="right">
                    <ons-icon icon="fa-link"></ons-icon>
                </div> -->
        </ons-list-item>
        <ons-list-item onclick="fn.loadView(1)">
          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-car, material:md-car"></ons-icon>
          </div>
          <div class="center">จองคิว</div>
        </ons-list-item>
        <ons-list-item onclick="fn.loadView(2)">
          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-envelope, material:md-email">
            </ons-icon>
          </div>
          <div class="center">ช้อความ</div>
        </ons-list-item>
        <ons-list-item onclick="fn.loadView(3)">
          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-view-headline, material:md-view-headline">
            </ons-icon>
          </div>
          <div class="center">ประวัติการใช้งาน</div>
        </ons-list-item>

        <ons-list-item onclick="showModal()">
          <div class="left">
            <ons-icon fixed-width class="list-item__icon" icon="ion-power, material:md-power""></ons-icon>
                </div>
                <div class=" center">ออกจากระบบ
          </div>
        </ons-list-item>
      </ons-list>

    </ons-page>
  </template>

  <template id="home2.html" var="MyNav">
    <ons-page><br>
      <ons-list modifier="inset">
        <ons-list-item expandable>
          คู่มือการใช้งาน
          <div class="expandable-content">ผู้ใช้ต้องทำการกรอกข้อมูลส่วนตัวและแก้ไขได้
            คุณสามารถทำรายการจองเวลาเลือกการล้างที่คุณต้องการ </div>
        </ons-list-item>
      </ons-list>

      <div style="height: 200px; padding: 1px 0 0 0;">
        <div class="card">
          <div class="list-item">
            <div class="list-item__left">
              <img class="list-item__thumbnail" src="img/mirage-1284.jpg" alt="Cute kitten">
            </div>

            <div class="list-item__center">
              <div class="list-item__title">วันจันทร์ 14 ก.พ. 2562 (11.00-12.00)</div>
              <div class="list-item__subtitle">ล้างห้องเครื่อง</div>

            </div>
          </div>
        </div>
      </div>
    </ons-page>
  </template>

  <template id="booking.html">
    <ons-page>
      <section>
        <p id="book">
          เวลาจอง
        </p>
      </section>
      <div class="row" id="data2">
        default
      </div>

    </ons-page>
  </template>

  <template id="message.html">
    <ons-page><br>
      <div class="card" id="bor">
        <h3 class="card__title">วันจันทร์ 14 ก.พ. 2562</h3>
        <div class="card__content">รถของท่านได้ทำการล้างเสร็จเรียบร้อยแล้ว ท่านสามารถเข้ามารับรถได้เลยค่ะ</div>
      </div>
    </ons-page>
  </template>

  <template id="history.html">
    <ons-page><br>
      <div style="height: 200px; padding: 1px 0 0 0;">
        <div class="card">
          <div class="list-item">
            <div class="list-item__left">
              <img class="list-item__thumbnail" src="img/mirage-1284.jpg" alt="Cute kitten">
            </div>

            <div class="list-item__center">
              <div class="list-item__title">วันจันทร์ 14 ก.พ. 2562</div>
              <div class="list-item__subtitle">ล้างอัดฉีดช่วงล้าง <br>
                ล้างสีดูดฝุ่น</div>
            </div>
          </div>
        </div>
      </div>


    </ons-page>
  </template>

  <template id="select_car.html">
    <ons-page>
      <div class="background"></div>
      <p>
        <!-- modifier="quiet" id="btnback" -->
        <ons-back-button>
          <ons-icon icon="md-chevron-left"></ons-icon>
          กลับ
        </ons-back-button>
      </p>
      <div class="namedata">รถของท่าน</div>

      <div class="row" id="showcar">
        default
      </div>

    </ons-page>
  </template>


  <template id="detailbook.html">
    <ons-page>
      <div class="background"></div>
      <p>
        <!-- <ons-button onclick="window.location.href='home.html'" modifier="quiet" id="btnback">
          <ons-icon icon="md-chevron-left"></ons-icon>
          กลับ
        </ons-button> -->
        <ons-back-button>Back</ons-back-button>
      </p>
      <div class="namedata">รายละเอียดข้อมูล</div>
      <div class="picuser">
        <ons-list-item>
          <div class="center">
            <img class="list-item__thumbnail" src="img/mirage-1284.jpg" id="pic">
          </div>
        </ons-list-item>
      </div>

      <div class="row" id="data3">
        default
      </div>
      </div>
    </ons-page>
  </template>

</body>

<script>



  window.onload = async function () {
    console.log("phone" + localStorage.getItem("phone"));
    let book = await localStorage.getItem("green");
    console.log("statusbook:" + book);
    // alert(localStorage.getItem('save'));

  };

  window.fn = {};

  window.fn.toggleMenu = function () {
    document.getElementById('appSplitter').right.toggle();
  };

  window.fn.loadView = function (index) {
    document.getElementById('appTabbar').setActiveTab(index);
    document.getElementById('sidemenu').close();
  };

  window.fn.loadLink = function (url) {
    window.open(url, '_blank');
  };

  window.fn.pushPage = function (page, anim) {
    if (anim) {
      document.getElementById('appNavigator').pushPage(page.id, { data: { title: page.title }, animation: anim });
    } else {
      document.getElementById('appNavigator').pushPage(page.id, { data: { title: page.title } });
    }
  };

  window.fn.load = function (page) {
    var myNavigator = document.getElementById('appNavigator');

    menu.close();
    myNavigator.resetToPage(page, { animation: 'fade' });
  };


  //Showreload
  function showModal() {
    var modal = document.querySelector('ons-modal');
    modal.show();
    setTimeout(function () {
      // modal.hide();
      window.location.href = 'login.html';
    }, 1500);
  }

  async function book() {
    try {
      let phone = localStorage.getItem("phone");
      const responseCar = await axios.get('http://localhost:8080/user/getshowcar/' + phone)
      const responseTime = await axios.get('http://localhost:8080/user/showtimes');
      const responseWork = await axios.get('http://localhost:8080/user/showwork');
      let data = responseTime.data // ให้ data เป็นก้อน time ที่ว่างหมดทุกช่อง
      if (responseWork.data || responseCar.data) { // เช็คว่าวันนี้มี work มั้ย (เป็น js อะไรที่ว่างไม่มีค่าอ่ะ เป็น false หมดเลย)
        var dc = [];
        data = responseTime.data.map(time => { // ให้ data ก้อนข้างบนอ่ะ ใส่ time เข้าไปใหม่ ตามเงื่อนไขข้างล่างโดยการ map (map เหมือน forEach แต่ ได้ก้อนใหม่ตามมแต่ที่เรา คืนค่า)
          console.log('ก่อน', time);
          time.hasWork = 0; // เพิ่ม haswork ให้ time ก้อนนี้ มันวนไง แต่ล่ะก้อนอ่ะ
          console.log('หลัง', time);
          const workOnThisTime = responseWork.data.filter(workInFilter => workInFilter.times === time.times)
          if (workOnThisTime) {
            time.hasWork = workOnThisTime.length;
            console.log('ถ้ามีwork', time);
          }
          workOnThisTime.forEach(workInForEach => {
            if (responseCar.data.some(car => car.car_num === workInForEach.car_num)) {
              time.hasMyCar = true;
              console.log('ถ้ามีรถเรา', time);
            }
          })

          const className = time.hasMyCar ? 'my-car' : time.hasWork === 2 ? 'has-car' : 'empty';
          const text = time.hasMyCar ? 'รถของคุณ' : time.hasWork === 2 ? 'ไม่ว่าง' : 'ว่าง';

          dc += `
        <ons-list modifier="inset">
          <ons-list-header> ${time.times}</ons-list-header>
          <ons-list-item>
            <button class="button--cta ${className}" style="width: 100%; margin: 0 auto;" onclick="check('${time.times}')" ${(time.hasWork === 2) ? 'disabled' : ''}>${text}</button>
          </ons-list-item>
        </ons-list>
        <br>`
          return time;
        })
      }
      myobj = document.getElementById("data2");
      myobj.innerHTML = dc;
      console.log(myobj);
   
    } catch (error) {
      console.log(error);
    }
  }

  var check = function (times) {
    console.log(times);

    localStorage.setItem("times", times);

    let booking = 1;
    localStorage.setItem("station", booking);
    console.log("station ::", booking);


    appNavigator.pushPage('select_car.html')
    let phone = localStorage.getItem("phone");
    axios.get('http://localhost:8080/user/getshowcar/' + phone)
      .then(function (response) {
        var dc = [];
        let data = response.data
        console.log(data);
        data.forEach(element => {

          dc +=
            '<ons-card onclick=selectwork("' + element.car_num + '")>' +
            '<div class="carnum">' + element.car_num + '</div>' +
            '<div class="datailcar">' + element.type + element.color + '</div>' +
            '</ons-card>'
        })
        myobj = document.getElementById("showcar");
        myobj.innerHTML = dc;
        // localStorage.setItem("car_num" , car_num);
        console.log(myobj);
      })
      .catch(function (error) {
        // handle error
        console.log(error);
      })

  }


  var selectwork = function (car_num) {

    appNavigator.pushPage('detailbook.html')
    console.log("car_num" + car_num)
    axios.get('http://localhost:8080/user/showdetailuser?car_num=' + car_num)
      .then(function (response) {
        var dc = [];
        let data = response.data
        console.log("response:" + data);
        data.forEach(element => {
          dc +=
            '<ons-card><div class="title">ชื่อ :' + element.fname +
            '</div>' +
            '<div class="title">เบอร์โทรฯ :' + element.phone +
            '</div>' +
            '<div class="title">ป้ายทะเบียน :' + element.car_num +
            '</div>' +
            '<div class="title">ประเภทรถ :' + element.type +
            '</div>' +
            '<div class="title">สีรถ :' + element.color +
            '</div>' +
            '</ons-card>' +


            '<div class="namedata">เลือกประเภทการล้าง</div>' +
            '<form method="POST">' +
            '<ons-row style="margin-top: 15px;">' +
            '<ons-col style="flex: 0 0 70%;margin: auto;max-width: 100%;margin-bottom: 10px;">' +
            '<ons-list>' +
            '<ons-list-item tappable>' +
            '<label class="left">' +
            '<ons-checkbox input-id="wash" value="ล้างห้องเครื่อง"></ons-checkbox>' +
            '</label>' +
            '<label class="center" for="wash">' +
            'ล้างห้องเครื่อง' +
            '</label>' +
            '</ons-list-item>' +
            '<ons-list-item tappable>' +
            '<label class="left">' +
            '<ons-checkbox input-id="spray" value="ล้างอัดฉีดช่วงล้าง"></ons-checkbox>' +
            '</label>' +
            '<label class="center" for="spray">' +
            'ล้างอัดฉีดช่วงล้าง' +
            '</label>' +
            '</ons-list-item>' +
            '<ons-list-item tappable>' +
            '<label class="left">' +
            '<ons-checkbox input-id="dust" value="ล้างสีดูดฝุ่น"></ons-checkbox>' +
            '</label>' +
            '<label class="center" for="dust">' +
            'ล้างสีดูดฝุ่น' +
            '</label>' +
            '</ons-list-item>' +
            '<ons-list-item tappable>' +
            '<label class="left">' +
            '<ons-checkbox input-id="asphalt" value="ล้างยางมะตอย"></ons-checkbox>' +
            '</label>' +
            '<label class="center" for="asphalt" >' +
            'ล้างยางมะตอย' +
            '</label>' +
            '</ons-list-item>' +
            '<ons-list-item tappable>' +
            '<label class="left">' +
            '<ons-checkbox input-id="fuel" value="ถ่ายน้ำมันเครื่อง(มอเตอร์ไซต์)"></ons-checkbox>' +
            '</label>' +
            '<label class="center" for="fuel" >' +
            'ถ่ายน้ำมันเครื่อง(มอเตอร์ไซต์)' +
            '</label>' +
            '</ons-list-item>' +
            '</ons-list>' +
            '</ons-col>' +
            '<div class="warn">' +
            ' กรุณากรอกข้อมูลของท่านให้ครบถ้วน เพื่อประโยชน์ของตัวลูกค้าเอง' +
            '</div></ons-row></form>' +
            ' <div class="setbtn">' +
            '<ons-button onclick="insert(' + "'" + car_num + "'" + ')" id="btnsubmit">' +
            ' ยืนยัน' +
            ' </ons-button>' +
            '</div>'

        })
        let myobj = document.getElementById("data3");
        myobj.innerHTML = dc;
        console.log(myobj);
      })
      .catch(function (error) {
        // handle error
        console.log(error);
      })

  }


  async function insert(car_num) {
    var wash_engin = 0;
    var spray_under = 0;
    var clean_dust = 0;
    var wash_asphalt = 0;
    var chang_fuel = 0;

    if (document.getElementById('wash').checked === true) {
      wash_engin = 1
    }
    if (document.getElementById('spray').checked === true) {
      spray_under = 1
    }
    if (document.getElementById('dust').checked === true) {
      clean_dust = 1
    }
    if (document.getElementById('asphalt').checked === true) {
      wash_asphalt = 1
    }
    if (document.getElementById('fuel').checked === true) {
      chang_fuel = 1
    }




    console.log(car_num, wash_engin, spray_under, clean_dust, wash_asphalt, chang_fuel)
    let time = localStorage.getItem("times")
    let book = localStorage.getItem("station");
    console.log(time);
    console.log(book);
    postAPI(car_num, wash_engin, spray_under, clean_dust, wash_asphalt, chang_fuel, time, book)


    // console.log(car_num, wash_engin, spray_under, clean_dust, wash_asphalt, chang_fuel)
    // let time = localStorage.getItem("times")
    // console.log(time);
    // postAPI(car_num, wash_engin, spray_under, clean_dust, wash_asphalt, chang_fuel, time)


  }

  var data = [];
  async function postAPI(car_num, wash_engin, spray_under, clean_dust, wash_asphalt, chang_fuel, time, book) {
    console.log(car_num);
    // let time = localStorage.getItem("times")
    // console.log(time);
    let html = '';
    var bodyFormData = new FormData();
    bodyFormData.set('car_num', car_num); // param1 :ชื่อตัวแปร , param2 : ค่าของมัน
    bodyFormData.set('wash_engin', wash_engin);
    bodyFormData.set('spray_under', spray_under);
    bodyFormData.set('clean_dust', clean_dust);
    bodyFormData.set('wash_asphalt', wash_asphalt);
    bodyFormData.set('chang_fuel', chang_fuel);
    bodyFormData.set('times', time);
    bodyFormData.set('station', book);

    await axios({
      method: 'post',
      url: 'http://localhost:8080/user/selecttypework',
      data: bodyFormData, // เอามาใส่ตรงนี้ 
      config: {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      }
    })
      .then(function (response) {
        //handle success
        console.log(response);
        location.href = "home.html";
        // localStorage.setItem("station", book);
      })
      .catch(function (response) {
        //handle error
        console.log(response);
      })
  }
</script>

</html>